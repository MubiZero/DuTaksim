# DuTaksim - ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

## ĞĞ±Ğ·Ğ¾Ñ€

DuTaksim - Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ ÑÑ‡ĞµÑ‚Ğ¾Ğ² Ñ collaborative Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸. ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ° Ğ½Ğ° Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ°Ñ… Clean Architecture Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ½Ğ° ÑĞ»Ğ¾Ğ¸.

---

## ğŸ›ï¸ Ğ’Ñ‹ÑĞ¾ĞºĞ¾ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Flutter App (Client)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Screens   â”‚  â”‚  Providers  â”‚  â”‚   Models    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                 â”‚                 â”‚            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                           â”‚                              â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                  â”‚  API Service    â”‚                     â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTP/REST
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Node.js Backend (Server)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Routes    â”‚  â”‚    Utils    â”‚  â”‚   Config    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                 â”‚                 â”‚            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                           â”‚                              â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                  â”‚  PostgreSQL     â”‚                     â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“± Frontend Architecture (Flutter)

### Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ÑĞ»Ğ¾ĞµĞ²

```
lib/
â”œâ”€â”€ config/                 # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
â”‚   â”œâ”€â”€ theme.dart         # Material Theme, Ñ†Ğ²ĞµÑ‚Ğ°
â”‚   â””â”€â”€ constants.dart     # API URL, ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹
â”‚
â”œâ”€â”€ models/                 # ĞœĞ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Data Layer)
â”‚   â”œâ”€â”€ user.dart          # User entity
â”‚   â”œâ”€â”€ bill.dart          # Bill entity
â”‚   â”œâ”€â”€ session.dart       # Session entity (NEW!)
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ services/              # Ğ¡ĞµÑ€Ğ²Ğ¸ÑÑ‹ (Service Layer)
â”‚   â”œâ”€â”€ api_service.dart   # HTTP ĞºĞ»Ğ¸ĞµĞ½Ñ‚ (Dio)
â”‚   â””â”€â”€ storage_service.dart # Local storage
â”‚
â”œâ”€â”€ providers/             # State Management (Business Logic)
â”‚   â”œâ”€â”€ user_provider.dart
â”‚   â”œâ”€â”€ bill_provider.dart
â”‚   â””â”€â”€ session_provider.dart (NEW!)
â”‚
â”œâ”€â”€ screens/               # UI Layer
â”‚   â”œâ”€â”€ onboarding_screen.dart
â”‚   â”œâ”€â”€ home_screen.dart
â”‚   â”œâ”€â”€ session_screen.dart (NEW!)
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ utils/                 # Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹
â”‚   â””â”€â”€ qr_generator.dart
â”‚
â””â”€â”€ main.dart             # Entry point + Routing
```

### State Management (Riverpod)

**ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿:** Unidirectional data flow

```
User Action â†’ Provider â†’ API Service â†’ Backend
                â†“
            State Update
                â†“
            UI Rebuild
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:**

```dart
// Provider Ñ auto-refresh
final sessionNotifierProvider = StateNotifierProvider<SessionNotifier, AsyncValue<BillSession?>>((ref) {
  return SessionNotifier(ref.watch(apiServiceProvider));
});

// Consumer Ğ² UI
ref.watch(sessionNotifierProvider).when(
  data: (session) => SessionWidget(session),
  loading: () => CircularProgressIndicator(),
  error: (err, stack) => ErrorWidget(err),
);
```

### ĞĞ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ (GoRouter)

**Declarative routing:**

```dart
GoRouter(
  routes: [
    GoRoute(path: '/', builder: (_, __) => MainNavigationScreen()),
    GoRoute(path: '/session', builder: (_, __) => SessionScreen()),
    GoRoute(path: '/bill/:id', builder: (_, state) => BillDetailScreen(id: state.params['id'])),
  ],
  redirect: (_, state) {
    final user = ref.read(currentUserProvider);
    if (user == null && state.location != '/onboarding') {
      return '/onboarding';
    }
    return null;
  },
);
```

---

## ğŸ–¥ï¸ Backend Architecture (Node.js)

### Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°

```
dutaksim_backend/
â”œâ”€â”€ routes/                 # API Routes (Controller Layer)
â”‚   â”œâ”€â”€ users.js           # User management
â”‚   â”œâ”€â”€ bills.js           # Bill CRUD
â”‚   â”œâ”€â”€ sessions.js        # Collaborative sessions (NEW!)
â”‚   â”œâ”€â”€ contacts.js        # Contact management (NEW!)
â”‚   â””â”€â”€ transactions.js    # Transaction queries
â”‚
â”œâ”€â”€ utils/                 # Business Logic
â”‚   â””â”€â”€ debtCalculator.js  # Debt optimization algorithm
â”‚
â”œâ”€â”€ config/                # Configuration
â”‚   â””â”€â”€ database.js        # PostgreSQL connection pool
â”‚
â”œâ”€â”€ migrations/            # Database Migrations
â”‚   â””â”€â”€ add_sessions.sql   # Sessions tables (NEW!)
â”‚
â”œâ”€â”€ database.sql           # Complete DB schema
â”œâ”€â”€ server.js             # Express app entry point
â””â”€â”€ .env                  # Environment variables
```

### API Endpoints Structure

**ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½:** RESTful API

```javascript
// routes/sessions.js
router.post('/create', async (req, res) => {
  // 1. Validate input
  // 2. Begin transaction
  // 3. Generate unique session code
  // 4. Insert session
  // 5. Add creator as participant
  // 6. Commit transaction
  // 7. Return full session object
});

router.get('/nearby', async (req, res) => {
  // 1. Get coordinates from query
  // 2. Query active sessions
  // 3. Calculate distances (Haversine)
  // 4. Filter by radius
  // 5. Return sorted list
});
```

### ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº

```javascript
try {
  await client.query('BEGIN');
  // ... operations
  await client.query('COMMIT');
  res.json(result);
} catch (error) {
  await client.query('ROLLBACK');
  console.error('Error:', error);
  res.status(500).json({ error: 'Operation failed' });
} finally {
  client.release();
}
```

---

## ğŸ—„ï¸ Database Architecture (PostgreSQL)

### Entity Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   users     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤    bills     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚bill_items   â”‚
â”‚             â”‚         â”‚              â”‚         â”‚             â”‚
â”‚ - id        â”‚         â”‚ - id         â”‚         â”‚ - id        â”‚
â”‚ - name      â”‚         â”‚ - paid_by    â”‚         â”‚ - bill_id   â”‚
â”‚ - phone     â”‚         â”‚ - total      â”‚         â”‚ - name      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚ - tips       â”‚         â”‚ - price     â”‚
       â”‚                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ - is_shared â”‚
       â”‚                       â”‚                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚                        â”‚
       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
       â”‚           â”‚                        â”‚          â”‚
       â”‚      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
       â”‚      â”‚bill_parti-  â”‚         â”‚item_participants     â”‚
       â”‚      â”‚cipants      â”‚         â”‚                      â”‚
       â””â”€â”€â”€â”€â”€â”€â”¤             â”‚         â”‚ - item_id            â”‚
              â”‚ - bill_id   â”‚         â”‚ - user_id            â”‚
              â”‚ - user_id   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   debts     â”‚
              â”‚             â”‚
              â”‚ - bill_id   â”‚
              â”‚ - debtor_id â”‚
              â”‚ - creditor  â”‚
              â”‚ - amount    â”‚
              â”‚ - is_paid   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  bill_sessions      â”‚â—„â”€â”€â”€â”
â”‚                     â”‚    â”‚
â”‚ - id                â”‚    â”‚
â”‚ - session_code      â”‚    â”‚
â”‚ - name              â”‚    â”‚
â”‚ - creator_id        â”‚    â”‚
â”‚ - latitude          â”‚    â”‚
â”‚ - longitude         â”‚    â”‚
â”‚ - status            â”‚    â”‚
â”‚ - bill_id (FK)      â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                   â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                   â”‚
  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚session_     â”‚    â”‚session_items  â”‚
  â”‚participants â”‚    â”‚               â”‚
  â”‚             â”‚    â”‚ - session_id  â”‚
  â”‚ - session_idâ”‚    â”‚ - added_by    â”‚
  â”‚ - user_id   â”‚    â”‚ - name        â”‚
  â”‚ - role      â”‚    â”‚ - price       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ - for_user_id â”‚
                     â”‚ - is_shared   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸

```sql
-- Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº ÑÑ‡ĞµÑ‚Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
CREATE INDEX idx_bills_paid_by ON bills(paid_by);
CREATE INDEX idx_bill_participants_user_id ON bill_participants(user_id);

-- Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº Ğ´Ğ¾Ğ»Ğ³Ğ¾Ğ²
CREATE INDEX idx_debts_debtor_id ON debts(debtor_id);
CREATE INDEX idx_debts_creditor_id ON debts(creditor_id);

-- GPS Ğ¿Ğ¾Ğ¸ÑĞº (NEW!)
CREATE INDEX idx_bill_sessions_location ON bill_sessions(latitude, longitude)
WHERE status = 'active';

-- ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑƒÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ñ… ÑĞµÑÑĞ¸Ğ¹
CREATE INDEX idx_bill_sessions_expires ON bill_sessions(expires_at);
```

### Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸

**ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ² Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸ÑÑ…:**

```sql
BEGIN;
  -- 1. Create bill
  INSERT INTO bills ...;

  -- 2. Add participants
  INSERT INTO bill_participants ...;

  -- 3. Add items
  INSERT INTO bill_items ...;

  -- 4. Calculate debts
  INSERT INTO debts ...;
COMMIT;
```

---

## ğŸ”„ Collaborative Sessions Flow

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° real-time (polling)

```
User A                    Backend                    User B
  â”‚                         â”‚                          â”‚
  â”‚â”€â”€â–º Create Session       â”‚                          â”‚
  â”‚â—„â”€â”€ Session + QR Code    â”‚                          â”‚
  â”‚                         â”‚                          â”‚
  â”‚                         â”‚â—„â”€â”€â”€ Scan QR / Join      â”‚
  â”‚                         â”‚â”€â”€â”€â”€ Session Details â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚                          â”‚
  â”‚â”€â”€â–º Add Item             â”‚                          â”‚
  â”‚     (auto-refresh)      â”‚                          â”‚
  â”‚                         â”‚      (polling 5s)        â”‚
  â”‚                         â”‚â—„â”€â”€â”€ Refresh Session â”€â”€â”€â”€â”‚
  â”‚                         â”‚â”€â”€â”€â”€ Updated Items â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚                          â”‚
  â”‚â”€â”€â–º Finalize Session     â”‚                          â”‚
  â”‚â—„â”€â”€ Bill Created         â”‚                          â”‚
  â”‚                         â”‚â”€â”€â”€â”€ Bill Created â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
```

### Polling vs WebSockets

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ polling (ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 5 ÑĞµĞºÑƒĞ½Ğ´)

**ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ polling?**
- âœ… ĞŸÑ€Ğ¾Ñ‰Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- âœ… ĞœĞµĞ½ÑŒÑˆĞµ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
- âœ… Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¾ĞºÑĞ¸/firewall
- âœ… Ğ”Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ use case (Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ instant updates)

**ĞœĞ¸Ğ½ÑƒÑÑ‹ WebSockets Ğ² Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼ ÑĞ»ÑƒÑ‡Ğ°Ğµ:**
- âŒ Ğ¡Ğ»Ğ¾Ğ¶Ğ½ĞµĞµ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
- âŒ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ ÑĞµÑ‚ÑĞ¼Ğ¸
- âŒ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€ (Socket.io)

### Session Lifecycle

```
1. ACTIVE
   â†“ (expires_at reached OR manual close)
2. CLOSED
   â†“ (creator finalizes)
3. FINALIZED
   â†“ (bill_id set)
   â†“
   Bill created in bills table
```

---

## ğŸ§® Debt Calculation Algorithm

### ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿

ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹ Ñ‡ĞµÑ€ĞµĞ· debt optimization.

### ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼

```javascript
// Ğ¨Ğ°Ğ³ 1: Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ·Ğ°Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ
for each item:
  if item.is_shared:
    cost_per_person = item.price / participant_count
    for each participant:
      balance[participant] -= cost_per_person
  else:
    balance[item.for_user_id] -= item.price

// Ğ¨Ğ°Ğ³ 2: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‡Ğ°ĞµĞ²Ñ‹Ğµ (Ğ´ĞµĞ»ÑÑ‚ÑÑ Ğ¿Ğ¾Ñ€Ğ¾Ğ²Ğ½Ñƒ)
tips_per_person = tips / participant_count
for each participant:
  balance[participant] -= tips_per_person

// Ğ¨Ğ°Ğ³ 3: Ğ£Ñ‡ĞµÑÑ‚ÑŒ ĞºÑ‚Ğ¾ Ğ·Ğ°Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ğ»
balance[paidBy] += totalAmount + tips

// Ğ¨Ğ°Ğ³ 4: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ´Ğ¾Ğ»Ğ³Ğ¸
for each participant (except paidBy):
  if balance[participant] < 0:
    CREATE DEBT {
      debtor_id: participant,
      creditor_id: paidBy,
      amount: abs(balance[participant])
    }
```

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€

```
Bill: 300 ÑĞ¾Ğ¼Ğ¾Ğ½Ğ¸ + 30 Ñ‡Ğ°ĞµĞ²Ñ‹Ñ… = 330 ÑĞ¾Ğ¼Ğ¾Ğ½Ğ¸
Participants: Alice, Bob, Charlie
Alice Ğ·Ğ°Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ğ»Ğ°

Items:
- ĞŸĞ¸Ñ†Ñ†Ğ° 150 (shared by all)
- Ğ¡Ğ°Ğ»Ğ°Ñ‚ 100 (only Bob)
- Ğ”ĞµÑĞµÑ€Ñ‚ 50 (shared by all)

Calculation:
Alice:  -50 (pizza) - 16.67 (desert) - 10 (tips) + 330 (paid) = +253.33
Bob:    -50 (pizza) - 100 (salad) - 16.67 (desert) - 10 (tips) = -176.67
Charlie: -50 (pizza) - 16.67 (desert) - 10 (tips) = -76.67

Debts:
Bob â†’ Alice: 176.67 ÑĞ¾Ğ¼Ğ¾Ğ½Ğ¸
Charlie â†’ Alice: 76.67 ÑĞ¾Ğ¼Ğ¾Ğ½Ğ¸
```

---

## ğŸŒ GPS & Geolocation

### Haversine Formula

Ğ Ğ°ÑÑ‡ĞµÑ‚ Ñ€Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ´Ğ²ÑƒĞ¼Ñ Ñ‚Ğ¾Ñ‡ĞºĞ°Ğ¼Ğ¸ Ğ½Ğ° ÑÑ„ĞµÑ€Ğµ:

```javascript
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // Earth radius in meters
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
  const Î”Î» = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
            Math.cos(Ï†1) * Math.cos(Ï†2) *
            Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c; // meters
}
```

### ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

1. **Ğ˜Ğ½Ğ´ĞµĞºÑ:** `idx_bill_sessions_location` Ğ½Ğ° `(latitude, longitude)`
2. **Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€:** `WHERE status = 'active'` (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ)
3. **In-memory filter:** Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸Ğ· Ğ‘Ğ”, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ñ€Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ

---

## ğŸ” Security Considerations

### Authentication

**Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° (Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑƒÑ€ÑĞ°):**
- Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ¼Ñ + Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½
- ĞĞµÑ‚ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¹
- Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ userId Ğ² SharedPreferences

**Ğ”Ğ»Ñ production:**
- âŒ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ JWT tokens
- âŒ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ OTP Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ
- âŒ Rate limiting Ğ½Ğ° API

### API Security

**Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:**
```javascript
app.use(cors()); // ĞÑ‚ĞºÑ€Ñ‹Ñ‚ Ğ´Ğ»Ñ Ğ²ÑĞµÑ…
```

**Ğ”Ğ»Ñ production:**
```javascript
app.use(cors({
  origin: ['https://yourdomain.com'],
  credentials: true
}));

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100
});
app.use('/api/', limiter);
```

### SQL Injection Protection

âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ parameterized queries:
```javascript
// âœ… SAFE
client.query('SELECT * FROM users WHERE phone = $1', [phone]);

// âŒ UNSAFE (Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼)
client.query(`SELECT * FROM users WHERE phone = '${phone}'`);
```

---

## ğŸ“ˆ Scalability Considerations

### Current Architecture

- **Concurrent users:** ~100-500
- **Database:** Single PostgreSQL instance
- **Backend:** Single Node.js process

### Scaling Strategy (Future)

1. **Horizontal Scaling:**
```
Load Balancer
     â†“
â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node 1  â”‚ Node 2 â”‚ Node 3 â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
         PostgreSQL
```

2. **Database Scaling:**
- Read replicas Ğ´Ğ»Ñ GET Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
- Connection pooling (ÑƒĞ¶Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ Ñ‡ĞµÑ€ĞµĞ· `pg.Pool`)
- Caching (Redis) Ğ´Ğ»Ñ Ñ‡Ğ°ÑÑ‚Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

3. **Sessions Cleanup:**
```javascript
// Cron job to delete expired sessions
setInterval(async () => {
  await pool.query(`
    DELETE FROM bill_sessions
    WHERE expires_at < NOW() - INTERVAL '1 day'
  `);
}, 3600000); // Every hour
```

---

## ğŸ§ª Testing Strategy

### Backend Tests (Recommended)

```javascript
// Jest tests
describe('Session Creation', () => {
  test('should create session with valid data', async () => {
    const response = await request(app)
      .post('/api/sessions/create')
      .send({ name: 'Test', creatorId: 'uuid' });

    expect(response.status).toBe(200);
    expect(response.body.session_code).toHaveLength(6);
  });
});
```

### Flutter Tests (Recommended)

```dart
// Widget tests
testWidgets('Session screen shows items', (tester) async {
  await tester.pumpWidget(ProviderScope(
    child: SessionScreen(),
  ));

  expect(find.text('Collaborative Session'), findsOneWidget);
});
```

---

## ğŸ“Š Performance Metrics

### Expected Response Times

- User registration: <200ms
- Bill creation: <500ms
- Session creation: <300ms
- Nearby sessions query: <150ms
- Session refresh: <100ms

### Database Query Optimization

```sql
-- Explain analyze Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
EXPLAIN ANALYZE
SELECT * FROM bill_sessions
WHERE status = 'active'
AND expires_at > NOW();

-- Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ idx_bill_sessions_status
```

---

## ğŸš€ Deployment Architecture

### Production Setup

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NGINX (Reverse Proxy)        â”‚
â”‚         SSL/TLS Termination               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                 â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ Static   â”‚    â”‚ Node.js  â”‚
â”‚ Flutter  â”‚    â”‚ Backend  â”‚
â”‚ Web App  â”‚    â”‚ :3000    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
              â”‚ PostgreSQL  â”‚
              â”‚   :5432     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Environment Variables

```env
# Production
NODE_ENV=production
DB_HOST=localhost
DB_PORT=5432
DB_NAME=dutaksim_prod
DB_USER=dutaksim_user
DB_PASSWORD=<secure_password>
PORT=3000

# Enable SSL for PostgreSQL
DB_SSL=true
```

---

## ğŸ“ Summary

**DuTaksim Architecture Features:**

âœ… **Clean Architecture** - Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ° ÑĞ»Ğ¾Ğ¸
âœ… **RESTful API** - ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ endpoints
âœ… **State Management** - Riverpod Ğ´Ğ»Ñ Flutter
âœ… **Real-time Collaboration** - Ñ‡ĞµÑ€ĞµĞ· polling (5s)
âœ… **Optimized Database** - Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
âœ… **Debt Optimization** - Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹
âœ… **Scalable Design** - Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğº Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼Ñƒ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
âœ… **Security** - parameterized queries, input validation

---

**Ğ’ĞµÑ€ÑĞ¸Ñ:** 2.0.0
**ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:** ĞĞºÑ‚ÑĞ±Ñ€ÑŒ 2025
